<html>
<head>
  <title>wtmoo metasearch</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'FantasqueSansMono NF', 'JetBrains Mono', 'Fira Code', Consolas, monospace;
    }

    body {
      display: flex;
      flex-flow: column nowrap;
    }

    :focus { outline: none; }
    #title { font-size: 500%; }
    #content { width: 60%; max-width: 50em; display: flex; flex-flow: row wrap; }
    input { font-size: 200%; font-family: 'FantasqueSansMono NF', 'JetBrains Mono', 'Fira Code', Consolas, monospace; border: 1px solid #888; padding: 0 6px; }
    #bang.error { background-color: #fbb; }
    #bang { background-color: #eee; text-align: right; width: 20%; border-radius: 5px 0 0 5px; } #query { width: 80%; border-left: none; border-radius: 0 5px 5px 0; }
    #bangnote { width: 20%; }
    #engines { width: 100%; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <center>
    <h1 id="title">!wtmoo</h1>
    <div id="content">
      <!-- TODO: grow if it's too big -->
      <input type="text" id="bang" value="!g">
      <input type="text" id="query" placeholder="search here">
      <span id="bangnote">google</span>
      <div id="engines" class="hidden">
        
      </div>
    </div>
  </center>
  <script>
    const engines = $;
    const engined = {};
    const engineList = [];
    const engineNames = {};
    for (const [aliases, url] of engines) { const name = aliases[0]; engineList.push(name); for (const alias of aliases) { engined[alias] = url; enginesNames[alias] = name; } }
    
    let bang = document.getElementById('bang'),
      query = document.getElementById('query'),
      engines = document.getElementById('engines');
    query.focus();
    function refreshEngines() {
      while (engines.lastChild) {
        engines.removeChild(engines.lastChild);
      }
      const queryEngine = bang.value.slice(1);
      for (const engine of engines) {
        if (queryEngine.includes(engine)) {
          const result = document.createElement('div');
          if (queryEngine === engine) {
            //
          }
        }
      }
    }
    function onBangKeydown(e) {
      switch (e.key) {
        case ' ':
          query.focus(); engines.classList.add('hidden'); query.selectionStart = 0; query.value = '';
          e.preventDefault();
          e.stopPropagation();
          break;
        default:
          refreshEngines();
      }
    }
    function onBangKeyup(e) {
      if (e.ctrlKey || e.altKey || e.shiftKey) { return; }
      if (bang.value.length === 0) {
        bang.value = '!';
      }
      if (bang.value.slice(1) in engined) { bang.classList.remove('error'); } else { bang.classList.add('error'); }
    }
    function onBangFocusout(e) {
      if (bang.value.slice(1) in engined) { bang.classList.remove('error'); } else { bang.classList.add('error'); }
    }
    function onQueryKeydown(e) {
      if (e.ctrlKey || e.altKey || e.shiftKey) { return; }
      switch (e.key) {
        case 'Backspace':
          if (query.value.length === 0) {
            bang.focus(); refreshEngines(); engines.classList.remove('hidden'); bang.selectionStart = bang.value.length;
            e.preventDefault();
            e.stopPropagation();
          }
          break;
        case 'Enter':
          if (bang.value.slice(1) in engined) {
            const url = engined[bang.value.slice(1)].replace('%q', encodeURIComponent(query.value)).replace('%+q', encodeURIComponent(query.value.replace(/ /g, '+')));
            location.href = url;
          }
          e.preventDefault();
          e.stopPropagation();
          break;
      }
    }
    function onEnginesClick(e) {
      console.log(e, e.target);
    }
    bang.addEventListener('keydown', onBangKeydown);
    bang.addEventListener('keyup', onBangKeyup);
    bang.addEventListener('focusout', onBangFocusout);
    query.addEventListener('keydown', onQueryKeydown);
    engines.addEventListener('click', onEnginesClick);
  </script>
</body>
</html>